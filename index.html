<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YEP 2025 - Gift Exchange Party</title>
    
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;600;700;800&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Nunito"', 'sans-serif'],
                        fun: ['"Baloo 2"', 'cursive'],
                    },
                    colors: {
                        pop: {
                            bg: '#F0F7F4',        
                            card: '#FFFFFF',
                            primary: '#FF6B6B',   
                            secondary: '#4ECDC4', 
                            yellow: '#FFE66D',    
                            dark: '#292F36',      
                            text: '#4A4A4A'
                        }
                    },
                    boxShadow: {
                        'block': '6px 6px 0px 0px rgba(41, 47, 54, 1)', 
                        'block-sm': '3px 3px 0px 0px rgba(41, 47, 54, 1)',
                    },
                    animation: {
                        'pop-in': 'popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        popIn: {
                            '0%': { transform: 'scale(0.8) translateY(20px)', opacity: '0' },
                            '100%': { transform: 'scale(1) translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Nunito', sans-serif;
            overflow: hidden;
            background-color: #ff9a9e;
            /* Enable GPU compositing for smoother scrolling */
            -webkit-overflow-scrolling: touch;
        }

        /* =========================================
           OPTIMIZED BACKGROUND EFFECTS START
        ========================================= */

        /* LAYER 1: Smooth Gradient Flow - Optimized for GPU */
        .bg-animated {
            position: fixed;
            inset: 0;
            z-index: -5;
            background: linear-gradient(-45deg, #FF9A9E, #FECFEF, #E0C3FC, #8EC5FC);
            background-size: 200% 200%; /* Reduced from 300% for better performance */
            animation: gradientBG 20s ease infinite; /* Slower = smoother */
            transform: translateZ(0); /* Force GPU layer */
            backface-visibility: hidden;
        }
        
        @keyframes gradientBG {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* LAYER 3: Bokeh Lights - GPU optimized */
        .bokeh-container {
            position: fixed;
            inset: 0;
            z-index: -3;
            pointer-events: none;
            transform: translateZ(0);
            contain: layout style paint; /* CSS containment for performance */
        }
        .bokeh {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.35) 0%, transparent 70%);
            animation: floatBokeh ease-in-out infinite alternate;
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        .bokeh:nth-child(1) { top: 10%; left: 10%; width: 120px; height: 120px; animation-duration: 25s; opacity: 0.5; }
        .bokeh:nth-child(2) { top: 70%; left: 80%; width: 160px; height: 160px; animation-duration: 30s; animation-delay: -5s; opacity: 0.4; }
        .bokeh:nth-child(3) { top: 40%; left: 40%; width: 80px; height: 80px; animation-duration: 22s; animation-delay: -10s; opacity: 0.35; }

        @keyframes floatBokeh {
            0% { transform: translate3d(0, 0, 0) scale(1); }
            100% { transform: translate3d(20px, -20px, 0) scale(1.05); }
        }

        /* LAYER 4: Floating Geometric Shapes - Simplified */
        .shapes-container {
            position: fixed;
            inset: 0;
            z-index: -2;
            pointer-events: none;
            transform: translateZ(0);
            contain: layout style paint;
        }
        .floating-shape {
            position: absolute;
            opacity: 0.5;
            animation: shapeFloat linear infinite;
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        .shape-sq { width: 25px; height: 25px; background: #FFE66D; border-radius: 4px; }
        .shape-cir { width: 20px; height: 20px; border-radius: 50%; border: 3px solid #FF6B6B; background: transparent; }

        .floating-shape:nth-child(1) { top: 20%; left: 5%; animation-duration: 30s; }
        .floating-shape:nth-child(2) { top: 80%; left: 85%; animation-duration: 35s; animation-direction: reverse; }
        .floating-shape:nth-child(3) { top: 15%; left: 70%; animation-duration: 32s; }

        @keyframes shapeFloat {
            0% { transform: translate3d(0, 40px, 0) rotate(0deg); opacity: 0; }
            15% { opacity: 0.5; }
            85% { opacity: 0.5; }
            100% { transform: translate3d(0, -40px, 0) rotate(360deg); opacity: 0; }
        }

        /* LAYER 5: Blobs - Static on tablets for performance */
        .blob {
            position: absolute;
            border-radius: 50%;
            opacity: 0.4;
            z-index: -1;
            animation: blobMove 25s infinite alternate ease-in-out;
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        .blob-1 { 
            top: -10%; left: -10%; width: 400px; height: 400px; 
            background: radial-gradient(circle, #FF9A9E 0%, transparent 70%);
        }
        .blob-2 { 
            bottom: -10%; right: -10%; width: 350px; height: 350px; 
            background: radial-gradient(circle, #A18CD1 0%, transparent 70%);
            animation-delay: -12s;
        }

        @keyframes blobMove {
            0% { transform: translate3d(0, 0, 0) scale(1); }
            100% { transform: translate3d(20px, 20px, 0) scale(1.05); }
        }

        /* LAYER 6: Emoji Rain - Reduced for smooth performance */
        .emoji-container {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
            transform: translateZ(0);
            contain: layout style paint;
        }
        
        .emoji-particle {
            position: absolute;
            font-size: 1.5rem;
            user-select: none;
            opacity: 0.6;
            animation: floatEmoji linear infinite;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        .emoji-particle:nth-child(1) { left: 10%; animation-duration: 22s; animation-delay: 0s; }
        .emoji-particle:nth-child(2) { left: 30%; animation-duration: 26s; animation-delay: 6s; font-size: 1.8rem; }
        .emoji-particle:nth-child(3) { left: 50%; animation-duration: 20s; animation-delay: 3s; }
        .emoji-particle:nth-child(4) { left: 70%; animation-duration: 24s; animation-delay: 9s; font-size: 1.7rem; }
        .emoji-particle:nth-child(5) { left: 90%; animation-duration: 28s; animation-delay: 2s; }
        .emoji-particle:nth-child(6) { left: 20%; animation-duration: 32s; animation-delay: 12s; opacity: 0.4; }

        @keyframes floatEmoji {
            0% { transform: translate3d(0, 105vh, 0) rotate(0deg); opacity: 0; }
            8% { opacity: 0.6; }
            92% { opacity: 0.6; }
            100% { transform: translate3d(0, -5vh, 0) rotate(15deg); opacity: 0; }
        }

        /* =========================================
           TABLET & MOBILE OPTIMIZATIONS
        ========================================= */
        @media (max-width: 1024px) {
            /* Reduce animation complexity on tablets */
            .bokeh { animation-duration: 35s !important; }
            .floating-shape { animation-duration: 40s !important; }
            .blob { animation: none !important; } /* Static blobs on tablet */
            .emoji-particle { 
                animation-duration: 30s !important;
                font-size: 1.3rem !important;
                opacity: 0.5 !important;
            }
            .bg-animated { animation-duration: 30s; }
        }

        @media (max-width: 768px) {
            /* Further reduce on smaller tablets/phones */
            .bokeh-container .bokeh:nth-child(3) { display: none; }
            .shapes-container .floating-shape:nth-child(3) { display: none; }
            .emoji-container .emoji-particle:nth-child(5),
            .emoji-container .emoji-particle:nth-child(6) { display: none; }
            .blob { opacity: 0.3; }
        }

        /* Reduce motion for users who prefer it */
        @media (prefers-reduced-motion: reduce) {
            .bg-animated,
            .bokeh,
            .floating-shape,
            .blob,
            .emoji-particle {
                animation: none !important;
            }
        }
        /* =========================================
           OPTIMIZED BACKGROUND EFFECTS END
        ========================================= */


        /* ===== CARD STYLES ===== */
        .glass-card {
            background: rgba(255, 255, 255, 0.8); /* More opaque = less GPU work */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 4px solid #292F36;
            border-radius: 30px;
            box-shadow: 10px 10px 0px 0px rgba(41, 47, 54, 0.8);
            position: relative; 
            z-index: 50;
            transform: translateZ(0); /* GPU layer */
        }

        /* Reduce backdrop-filter on tablets for performance */
        @media (max-width: 1024px) {
            .glass-card {
                background: rgba(255, 255, 255, 0.92);
                backdrop-filter: blur(6px);
                -webkit-backdrop-filter: blur(6px);
            }
        }

        @media (max-width: 768px) {
            .glass-card {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: none;
                -webkit-backdrop-filter: none;
                border-radius: 20px;
                padding: 1rem;
            }
        }

        .digit-box {
            width: 90px; 
            height: 120px;
            background: #FFE66D;
            border: 4px solid #292F36;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Baloo 2', cursive; 
            font-size: 5rem;
            font-weight: 800;
            color: #292F36;
            box-shadow: 4px 4px 0px 0px #292F36;
            transition: all 0.2s ease;
            line-height: 1;
            padding-top: 10px;
            transform: translateZ(0); /* GPU acceleration */
        }
        
        .digit-box.spinning {
            background: #ffffff;
            color: #FF6B6B;
            animation: shake 0.4s ease-in-out infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateZ(0) rotate(0deg); }
            25% { transform: translateZ(0) rotate(-2deg); }
            75% { transform: translateZ(0) rotate(2deg); }
        }

        /* Tablet responsive digit boxes */
        @media (max-width: 1024px) {
            .digit-box {
                width: 75px;
                height: 100px;
                font-size: 4rem;
                border-radius: 16px;
            }
        }

        @media (max-width: 768px) {
            .digit-box {
                width: 60px;
                height: 85px;
                font-size: 3rem;
                border-radius: 14px;
                border-width: 3px;
            }
        }

        .btn-blocky {
            border: 3px solid #292F36;
            border-radius: 16px;
            font-weight: 800;
            text-transform: uppercase;
            box-shadow: 5px 5px 0px 0px #292F36;
            transition: all 0.1s ease;
            font-family: 'Baloo 2', cursive;
            letter-spacing: 1px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .btn-blocky::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: 0.5s;
        }
        .btn-blocky:hover::after { left: 100%; }
        
        .btn-blocky:not(:disabled):active {
            transform: translate(4px, 4px);
            box-shadow: 1px 1px 0px 0px #292F36;
        }
        .btn-blocky:disabled {
            background: #e5e7eb !important;
            color: #9ca3af !important;
            border-color: #d1d5db !important;
            box-shadow: 2px 2px 0px 0px #d1d5db !important;
            cursor: not-allowed;
            opacity: 0.8;
        }
        .btn-blocky:not(:disabled):hover { 
            transform: translate(2px, 2px); 
            box-shadow: 3px 3px 0px 0px #292F36; 
        }

        .input-flat {
            border: 3px solid #292F36;
            border-radius: 16px;
            box-shadow: 4px 4px 0px 0px rgba(41, 47, 54, 0.2);
            transition: all 0.2s ease;
            font-family: 'Nunito', sans-serif;
            background: rgba(255,255,255,0.9);
        }
        .input-flat:focus {
            outline: none;
            box-shadow: 6px 6px 0px 0px #4ECDC4;
            border-color: #4ECDC4;
            transform: translateY(-2px);
        }

        .history-item {
            background: rgba(255,255,255,0.9);
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: transform 0.15s ease, border-color 0.15s ease;
            font-family: 'Nunito', sans-serif;
            animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .history-item:hover {
            border-color: #292F36;
            transform: scale(1.02) rotate(-1deg);
            background: #FFF9C4; 
            z-index: 10;
        }

        @keyframes slideIn { 
            from { opacity: 0; transform: translateX(-20px); } 
            to { opacity: 1; transform: translateX(0); } 
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Modal Styles */
        .modal-box {
            border: 4px solid #292F36;
            border-radius: 24px;
            box-shadow: 8px 8px 0px 0px #292F36;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 relative font-sans">

    <div class="bg-animated"></div>
    
    <!-- Removed bg-noise -->

    <div class="bokeh-container">
        <div class="bokeh"></div>
        <div class="bokeh"></div>
        <div class="bokeh"></div>
    </div>

    <div class="shapes-container">
        <div class="floating-shape shape-sq"></div>
        <div class="floating-shape shape-tri"></div>
        <div class="floating-shape shape-cir"></div>
    </div>

    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <div class="emoji-container">
        <div class="emoji-particle">üéÅ</div>
        <div class="emoji-particle">ü•Ç</div>
        <div class="emoji-particle">‚ú®</div>
        <div class="emoji-particle">üí∞</div>
        <div class="emoji-particle">üéâ</div>
        <div class="emoji-particle">üíñ</div>
    </div>

    <!-- Overlay Click to Start -->
    <div id="start-overlay" class="fixed inset-0 z-[100] bg-gradient-to-br from-pop-primary/90 via-pop-secondary/90 to-pop-yellow/90 flex items-center justify-center cursor-pointer" onclick="startApp()">
        <div class="text-center animate-pulse">
            <div class="text-8xl mb-6">üéâ</div>
            <h2 class="font-fun text-4xl md:text-5xl text-white font-extrabold drop-shadow-lg mb-4">YEAR END PARTY 2025</h2>
            <p class="text-white/90 text-xl font-bold mb-8">Trao qu√† li·ªÅn tay - V·∫≠n may s·∫Ω t·ªõi</p>
            <div class="inline-flex items-center gap-3 bg-white text-pop-dark px-8 py-4 rounded-2xl font-bold text-xl shadow-block hover:shadow-block-sm hover:translate-x-1 hover:translate-y-1 transition-all">
                <i class="fa-solid fa-play"></i>
                <span>Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu</span>
            </div>
            <p class="text-white/70 text-sm mt-4"><i class="fa-solid fa-volume-high mr-2"></i>√Çm thanh s·∫Ω t·ª± ƒë·ªông ph√°t</p>
        </div>
    </div>

    <div class="w-full max-w-5xl glass-card p-6 md:p-10 flex flex-col gap-8 animate-pop-in">
        
        <div class="flex justify-between items-start">
            <div class="relative">
                <h1 class="font-fun text-5xl md:text-6xl text-pop-dark leading-none font-extrabold drop-shadow-sm">
                    YEAR END PARTY <span class="text-pop-primary inline-block hover:scale-110 transition-transform cursor-pointer">2025</span>
                </h1>
                <p class="text-pop-text font-bold text-lg mt-1 italic opacity-80">Trao qu√† li·ªÅn tay - V·∫≠n may s·∫Ω t·ªõi</p>
            </div>
            
            <div class="flex gap-3">
                <!-- N√∫t b·∫≠t t·∫Øt √¢m thanh -->
                <button id="btn-sound" onclick="toggleSound()" class="w-12 h-12 bg-white border-2 border-pop-dark rounded-xl flex items-center justify-center shadow-block-sm hover:shadow-none hover:translate-x-[3px] hover:translate-y-[3px] transition-all group">
                    <i id="icon-sound" class="fa-solid fa-volume-high text-pop-dark text-xl group-hover:scale-110 transition-transform"></i>
                </button>

                <!-- N√∫t c√†i ƒë·∫∑t -->
                <button onclick="my_modal_1.showModal()" class="w-12 h-12 bg-white border-2 border-pop-dark rounded-xl flex items-center justify-center shadow-block-sm hover:shadow-none hover:translate-x-[3px] hover:translate-y-[3px] transition-all group">
                    <i class="fa-solid fa-gear text-pop-dark text-xl group-hover:rotate-90 transition-transform duration-500"></i>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 mt-2">
            
            <div class="lg:col-span-7 flex flex-col items-center gap-8">
                
                <div class="bg-blue-50/80 backdrop-blur w-full p-8 rounded-3xl border-4 border-dashed border-blue-300 flex justify-center items-center gap-4 relative shadow-inner">
                    <div class="absolute -top-4 bg-white px-4 py-1 border-2 border-blue-300 rounded-full text-xs font-extrabold text-blue-500 uppercase tracking-wider shadow-sm">
                        <i class="fa-solid fa-star text-yellow-400 mr-1"></i> Con s·ªë b√≠ ·∫©n
                    </div>
                    <div id="box-1" class="digit-box"><span id="digit-1">?</span></div>
                    <div id="box-2" class="digit-box"><span id="digit-2">?</span></div>
                    <div id="box-3" class="digit-box"><span id="digit-3">?</span></div>
                </div>

                <div class="w-full flex flex-col gap-4">
                    <div class="relative group">
                        <input type="text" id="current-player" oninput="checkPlayer()" onkeypress="handleKeyPress(event)" autocomplete="off"
                            class="input-flat w-full py-4 px-5 pl-14 text-xl font-bold font-sans text-pop-dark placeholder-gray-400" 
                            placeholder="Ai l√† ng∆∞·ªùi may m·∫Øn ti·∫øp theo?">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-pop-secondary transition-colors">
                            <i class="fa-solid fa-user-astronaut text-2xl"></i>
                        </div>
                    </div>

                    <div id="player-msg" class="h-6 text-center font-bold text-sm text-gray-500 transition-all duration-300 italic">
                        H√£y nh·∫≠p t√™n ƒë·ªÉ may m·∫Øn g√µ c·ª≠a...
                    </div>

                    <div class="grid grid-cols-4 gap-4">
                        <button id="btn-spin" onclick="startSpin()" disabled 
                            class="col-span-3 btn-blocky bg-pop-primary text-white text-xl py-4 hover:bg-[#ff5252] flex items-center justify-center gap-3">
                            <i class="fa-solid fa-gift animate-pulse"></i> QUAY S·ªê NGAY
                        </button>
                        <button onclick="nextPerson()" 
                            class="col-span-1 btn-blocky bg-white text-pop-dark border-pop-dark hover:bg-gray-50">
                            <i class="fa-solid fa-forward text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 flex flex-col h-full max-h-[500px]">
                <div class="flex justify-between items-end mb-3 px-1">
                    <h3 class="font-fun text-2xl text-pop-dark font-bold"><i class="fa-solid fa-clock-rotate-left mr-2 text-pop-secondary"></i>L·ªãch s·ª≠</h3>
                    <span class="text-sm font-bold bg-pop-yellow px-3 py-1 rounded-full border-2 border-pop-dark shadow-[2px_2px_0px_0px_rgba(41,47,54,1)]">
                        Kho: <span id="remaining-count">0</span> üéÅ
                    </span>
                </div>

                <div class="bg-white/60 rounded-2xl border-2 border-white p-2 flex-1 overflow-hidden flex flex-col shadow-inner backdrop-blur-sm">
                    <ul id="history-list" class="flex-1 overflow-y-auto space-y-2 p-1 custom-scrollbar">
                        <div id="empty-state" class="h-full flex flex-col items-center justify-center text-gray-400 opacity-70">
                            <i class="fa-solid fa-box-open text-5xl mb-3 text-gray-300"></i>
                            <span class="font-bold">Ch∆∞a c√≥ ai nh·∫≠n qu√†</span>
                            <span class="text-xs">Nhanh tay l√™n n√†o!</span>
                        </div>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <dialog id="my_modal_1" class="modal backdrop-blur-md">
        <div class="modal-box bg-white p-6 max-w-2xl">
            <h3 class="font-fun text-2xl mb-2 text-pop-primary font-bold uppercase border-b-2 border-gray-100 pb-2">
                <i class="fa-solid fa-list-check mr-2"></i>C·∫•u h√¨nh danh s√°ch
            </h3>
            <p class="text-sm text-gray-500 mb-1 mt-2"><b>ƒê·ªãnh d·∫°ng:</b> T√™n Ng∆∞·ªùi Ch∆°i, M√£ qu√† 1, M√£ qu√† 2...</p>
            <textarea id="input-list" class="w-full h-48 bg-gray-50 border-2 border-gray-200 rounded-xl p-4 font-bold text-gray-600 focus:outline-none focus:border-pop-secondary focus:bg-white transition-all duration-300 font-sans resize-none mt-2"
                placeholder="Nguyen Van A, 1, 2, 3&#10;Tran Thi B, 4" spellcheck="false"></textarea>
            <div class="modal-action grid grid-cols-2 gap-4 mt-6">
                <form method="dialog" class="w-full"><button class="btn-blocky w-full py-3 bg-gray-200 text-gray-600 border-gray-400 shadow-[4px_4px_0px_0px_#9ca3af]">ƒê√≥ng</button></form>
                <button onclick="saveData()" class="btn-blocky w-full py-3 bg-pop-secondary text-white border-pop-dark">L∆∞u D·ªØ Li·ªáu</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script>
        // --- GAME LOGIC ---
        let playerList = [];
        let giftMap = {};
        let allGiftNumbers = [];
        let drawnNumbers = [];
        let isSpinning = false;
        let checkPlayerTimeout;
        let isMuted = false;
        
        // --- C·∫§U H√åNH √ÇM THANH ---
        const bgMusic = new Audio('sound_nen.mp3'); 
        bgMusic.loop = true; 
        bgMusic.volume = 0.5;

        const spinMusic = new Audio('sound_quay.mp3'); 
        spinMusic.loop = true;
        spinMusic.volume = 1.0;

        // √Çm thanh th·∫Øng s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông khi quay xong
        let winAudio = null;
        
        // --- H·ªÜ TH·ªêNG RANDOM √ÇM THANH KH√îNG L·∫∂P ---
        const TOTAL_WIN_SOUNDS = 9;
        let winSoundQueue = []; // Queue c√°c √¢m thanh s·∫Ω ph√°t
        let lastPlayedSounds = []; // L∆∞u 3 √¢m thanh g·∫ßn nh·∫•t ƒë·ªÉ tr√°nh l·∫∑p
        
        // H√†m t·∫°o queue m·ªõi khi h·∫øt ho·∫∑c kh·ªüi t·∫°o
        function shuffleWinSounds() {
            // T·∫°o m·∫£ng [1, 2, 3, ..., 9]
            let sounds = Array.from({length: TOTAL_WIN_SOUNDS}, (_, i) => i + 1);
            
            // Fisher-Yates shuffle
            for (let i = sounds.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [sounds[i], sounds[j]] = [sounds[j], sounds[i]];
            }
            
            // ƒê·∫£m b·∫£o √¢m thanh ƒë·∫ßu queue kh√¥ng tr√πng v·ªõi √¢m thanh v·ª´a ph√°t
            if (lastPlayedSounds.length > 0) {
                const lastPlayed = lastPlayedSounds[lastPlayedSounds.length - 1];
                if (sounds[0] === lastPlayed) {
                    // ƒê·ªïi v·ªã tr√≠ v·ªõi ph·∫ßn t·ª≠ random kh√°c
                    const swapIdx = Math.floor(Math.random() * (sounds.length - 1)) + 1;
                    [sounds[0], sounds[swapIdx]] = [sounds[swapIdx], sounds[0]];
                }
            }
            
            return sounds;
        }
        
        // L·∫•y √¢m thanh ti·∫øp theo t·ª´ queue
        function getNextWinSound() {
            if (winSoundQueue.length === 0) {
                winSoundQueue = shuffleWinSounds();
            }
            const soundIndex = winSoundQueue.shift();
            
            // C·∫≠p nh·∫≠t danh s√°ch √¢m thanh ƒë√£ ph√°t (gi·ªØ t·ªëi ƒëa 3)
            lastPlayedSounds.push(soundIndex);
            if (lastPlayedSounds.length > 3) {
                lastPlayedSounds.shift();
            }
            
            return soundIndex;
        }

        const defaultData = `Ng·ªçc Dung, 1,
Ph∆∞∆°ng Ly, 2
Qu·ªëc Hi·ªáu, 3, 
Ch√¢u Vinh, 4
T∆∞·ªùng Duy, 5
Thanh T√¢m, 6
Ph∆∞∆°ng Th√πy, 7
Minh Qu√¢n, 8
H·ªìng ƒê√†o, 9
ƒêƒÉng Khoa, 10
Ph∆∞·ª£ng Linh, 11
Sƒ© Nguy√™n, 12, 13, 14, 15
H·ªìng Di·ªÖm, 16
Thi√™n Khang, 17
Th·∫ø H√†o, 18
Minh Th∆∞∆°ng, 19
H·ªìng √Ånh, 20
Thanh Duy, 21
Vƒ©nh Ph√°t, 22
Nh∆∞ Qu·ª≥nh, 23
Quang Minh, 24
H·ªìng Ch√¢u, 25
ƒê√¨nh VƒÉn, 26`;

        window.onload = function() {
            document.getElementById('input-list').value = defaultData;
            saveData(false);
            // Kh√¥ng t·ª± ƒë·ªông ph√°t nh·∫°c - ch·ªù ng∆∞·ªùi d√πng click overlay
        }

        // H√†m kh·ªüi ƒë·ªông app khi click overlay
        function startApp() {
            const overlay = document.getElementById('start-overlay');
            
            // ·∫®n overlay v·ªõi animation
            overlay.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            overlay.style.opacity = '0';
            overlay.style.transform = 'scale(1.1)';
            
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 500);
            
            // Ph√°t nh·∫°c n·ªÅn ngay l·∫≠p t·ª©c
            if (!isMuted) {
                bgMusic.play().catch(e => console.log("L·ªói ph√°t nh·∫°c:", e));
            }
            
            // Focus v√†o √¥ nh·∫≠p t√™n
            DOM.currentPlayer.focus();
        }

        // C·∫≠p nh·∫≠t UI n√∫t √¢m thanh
        function updateSoundButtonUI() {
            const icon = document.getElementById('icon-sound');
            const btn = document.getElementById('btn-sound');
            
            if (isMuted) {
                icon.className = 'fa-solid fa-volume-xmark text-gray-500 text-xl group-hover:scale-110 transition-transform';
                btn.className = 'w-12 h-12 bg-gray-100 border-2 border-gray-400 rounded-xl flex items-center justify-center shadow-none transition-all group';
            } else {
                icon.className = 'fa-solid fa-volume-high text-pop-dark text-xl group-hover:scale-110 transition-transform';
                btn.className = 'w-12 h-12 bg-white border-2 border-pop-dark rounded-xl flex items-center justify-center shadow-block-sm hover:shadow-none hover:translate-x-[3px] hover:translate-y-[3px] transition-all group';
            }
        }

        function toggleSound() {
            isMuted = !isMuted;
            
            if (isMuted) {
                // T·∫Øt t·∫•t c·∫£ √¢m thanh
                bgMusic.pause();
                spinMusic.pause();
                if(winAudio) winAudio.pause();
            } else {
                // B·∫≠t nh·∫°c ph√π h·ª£p v·ªõi tr·∫°ng th√°i hi·ªán t·∫°i
                if (!isSpinning) {
                    bgMusic.play().catch(e => console.log("C·∫ßn t∆∞∆°ng t√°c ƒë·ªÉ ph√°t nh·∫°c"));
                } else {
                    spinMusic.play().catch(e => console.log(e));
                }
            }
            
            updateSoundButtonUI();
        }

        function normalizeStr(str) {
            if (!str) return "";
            return str.normalize('NFC').trim().replace(/\s+/g, ' ').toLowerCase();
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !document.getElementById('btn-spin').disabled) {
                startSpin();
            }
        }

        function saveData(showAlert = true) {
            const raw = document.getElementById('input-list').value.trim();
            if (!raw) { alert('Vui l√≤ng nh·∫≠p danh s√°ch!'); return; }
            
            const lines = raw.split('\n').filter(line => line.trim());
            playerList = [];
            giftMap = {};
            allGiftNumbers = [];
            drawnNumbers = [];
            const usedNumbers = new Set();
            
            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 2) {
                    const nameRaw = parts[0];
                    const giftNumbers = [];
                    
                    for (let i = 1; i < parts.length; i++) {
                        const num = parseInt(parts[i]);
                        if (!isNaN(num) && num > 0) {
                            if (!usedNumbers.has(num)) {
                                usedNumbers.add(num);
                                giftNumbers.push(num);
                                allGiftNumbers.push(num);
                                giftMap[num] = nameRaw.trim();
                            }
                        }
                    }
                    
                    if (nameRaw && giftNumbers.length > 0) {
                        playerList.push({
                            name: nameRaw.trim(),
                            searchKey: normalizeStr(nameRaw),
                            giftNumbers: giftNumbers
                        });
                    }
                }
            });
            
            if (playerList.length === 0) { 
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá!'); 
                return; 
            }
            
            resetGame();
            document.getElementById('my_modal_1').close();
            
            if (showAlert) alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t: ${playerList.length} ng∆∞·ªùi v·ªõi ${allGiftNumbers.length} m√≥n qu√†.`);
        }

        const DOM = {
            get currentPlayer() { return document.getElementById('current-player'); },
            get playerMsg() { return document.getElementById('player-msg'); },
            get btnSpin() { return document.getElementById('btn-spin'); },
            get historyList() { return document.getElementById('history-list'); },
            get remainingCount() { return document.getElementById('remaining-count'); },
            get emptyState() { return document.getElementById('empty-state'); },
        };

        function checkPlayer() {
            clearTimeout(checkPlayerTimeout);
            checkPlayerTimeout = setTimeout(() => {
                const inputVal = DOM.currentPlayer.value;
                const searchKey = normalizeStr(inputVal);
                const msg = DOM.playerMsg;
                const btn = DOM.btnSpin;

                if (searchKey === "") {
                    msg.innerHTML = "H√£y nh·∫≠p t√™n ƒë·ªÉ th·∫ßn t√†i g√µ c·ª≠a...";
                    msg.className = "h-6 text-center font-bold text-sm text-gray-500 transition-all italic";
                    btn.disabled = true;
                    return;
                }
                
                const player = playerList.find(p => p.searchKey === searchKey);
                if (player) {
                    msg.innerHTML = `<i class="fa-solid fa-check-circle"></i> Ch√†o <b>${player.name}</b>! Ch√∫c b·∫°n may m·∫Øn!`;
                    msg.className = "h-6 text-center font-bold text-sm text-pop-secondary transition-all";
                    btn.disabled = false;
                } else {
                    msg.innerHTML = `<i class="fa-solid fa-circle-xmark"></i> Kh√¥ng t√¨m th·∫•y t√™n trong danh s√°ch...`;
                    msg.className = "h-6 text-center font-bold text-sm text-red-400 transition-all";
                    btn.disabled = true;
                }
            }, 100); 
        }

        function startSpin() {
            if (isSpinning) return;

            bgMusic.pause();
            
            if(!isMuted) {
                spinMusic.currentTime = 0;
                spinMusic.play();
            }

            const inputVal = DOM.currentPlayer.value;
            const currentPlayer = playerList.find(p => p.searchKey === normalizeStr(inputVal));
            
            const drawnSet = new Set(drawnNumbers);
            const excludeNumbers = currentPlayer ? new Set(currentPlayer.giftNumbers) : new Set();
            
            let availableNumbers = allGiftNumbers.filter(num => 
                !drawnSet.has(num) && !excludeNumbers.has(num)
            );

            if (availableNumbers.length === 0) {
                const remaining = allGiftNumbers.filter(num => !drawnSet.has(num));
                if (remaining.length > 0) {
                    alert("Ch·ªâ c√≤n l·∫°i qu√† c·ªßa ch√≠nh b·∫°n! H√£y ho√°n ƒë·ªïi v·ªõi ng∆∞·ªùi kh√°c.");
                    availableNumbers = remaining;
                } else {
                    alert("ƒê√£ h·∫øt qu√† r·ªìi!");
                    spinMusic.pause();
                    if(!isMuted) bgMusic.play();
                    return;
                }
            }

            const winnerNum = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
            const winnerStr = winnerNum.toString().padStart(3, '0');

            isSpinning = true;
            DOM.btnSpin.disabled = true;
            DOM.currentPlayer.disabled = true;

            const boxes = [document.getElementById('box-1'), document.getElementById('box-2'), document.getElementById('box-3')];
            const digits = [document.getElementById('digit-1'), document.getElementById('digit-2'), document.getElementById('digit-3')];

            boxes.forEach(box => box.classList.add('spinning'));
            
            const revealDigit = (box, digit, value) => {
                if (digit._animFrame) {
                    cancelAnimationFrame(digit._animFrame);
                    digit._animFrame = null;
                }
                digit.textContent = value;
                box.classList.remove('spinning');
                box.style.background = '#FF6B6B';
                box.style.color = 'white';
                box.style.borderColor = '#FF6B6B';
                box.style.transform = 'scale(1.1)';
                setTimeout(() => box.style.transform = 'scale(1)', 200);
            };

            digits.forEach(digit => {
                let lastUpdate = 0;
                const frameInterval = window.innerWidth <= 1024 ? 80 : 50; // Slower on tablets
                const animate = (timestamp) => {
                    if (timestamp - lastUpdate >= frameInterval) { 
                        digit.textContent = Math.floor(Math.random() * 10);
                        lastUpdate = timestamp;
                    }
                    digit._animFrame = requestAnimationFrame(animate);
                };
                digit._animFrame = requestAnimationFrame(animate);
            });

            [1500, 2500, 3500].forEach((time, i) => {
                setTimeout(() => {
                    revealDigit(boxes[i], digits[i], winnerStr[i]);
                    if (i === 2) {
                        setTimeout(() => finalizeSpin(winnerNum, currentPlayer?.name || "Kh√°ch M·ªùi"), 300);
                    }
                }, time);
            });
        }

        function finalizeSpin(number, playerName) {
            isSpinning = false;
            drawnNumbers.push(number);

            spinMusic.pause();

            // --- LOGIC √ÇM THANH T·ªêI ∆ØU (KH√îNG L·∫∂P) ---
            if (!isMuted) {
                // L·∫•y √¢m thanh ti·∫øp theo t·ª´ queue shuffle
                const soundIndex = getNextWinSound();
                const soundPath = `sound_trung (${soundIndex}).mp3`;
                
                winAudio = new Audio(soundPath);
                winAudio.loop = false;
                winAudio.volume = 1.0;
                winAudio.play().catch(e => console.log("L·ªói ph√°t √¢m thanh chi·∫øn th·∫Øng:", e));
            }

            setTimeout(() => {
                if(winAudio) winAudio.pause();
                if(!isMuted) bgMusic.play();
            }, 6000);

            runFireworks(); 
            
            const giftOwner = giftMap[number] || "???";
            updateHistory(number, playerName, giftOwner);
            updateCount();
        }

        function runFireworks() {
            const duration = 2500; // Reduced duration
            const animationEnd = Date.now() + duration;
            const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#FFFFFF', '#DDA0DD'];
            
            // Detect if tablet/mobile for reduced particles
            const isTablet = window.innerWidth <= 1024;
            const baseParticles = isTablet ? 25 : 40;

            const interval = setInterval(() => {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) { clearInterval(interval); return; }
                
                const particleCount = Math.floor(baseParticles * (timeLeft / duration));
                
                confetti({
                    particleCount: particleCount,
                    startVelocity: isTablet ? 25 : 30,
                    spread: 360,
                    origin: { x: Math.random(), y: Math.random() - 0.2 },
                    colors,
                    zIndex: 9999,
                    shapes: ['square', 'circle'],
                    disableForReducedMotion: true // Respect user preference
                });
            }, isTablet ? 300 : 250); // Slower interval on tablets
        }

        function updateHistory(number, playerName, giftOwner) {
            const ul = DOM.historyList;
            const emptyState = DOM.emptyState;
            if (emptyState) emptyState.style.display = 'none';

            const li = document.createElement('li');
            li.className = 'history-item flex justify-between items-center px-4 py-3';
            const numStr = number.toString().padStart(3, '0');
            
            li.innerHTML = `
                <div class="flex flex-col">
                    <span class="font-bold text-pop-dark truncate text-lg">${playerName}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-fun text-2xl text-pop-primary font-bold bg-red-50 px-3 py-1 rounded-xl border border-red-100 shadow-sm">${numStr}</span>
                </div>
            `;
            
            ul.prepend(li);
        }

        function nextPerson() {
            if (isSpinning) return;
            const input = DOM.currentPlayer;
            input.value = "";
            input.disabled = false;
            
            ['box-1', 'box-2', 'box-3'].forEach((boxId, i) => {
                const box = document.getElementById(boxId);
                const digit = document.getElementById(`digit-${i + 1}`);
                
                if (digit._animFrame) {
                    cancelAnimationFrame(digit._animFrame);
                    digit._animFrame = null;
                }
                
                digit.textContent = "?";
                box.style.background = '';
                box.style.color = '';
                box.style.borderColor = '';
                box.style.transform = '';
                box.classList.remove('spinning');
            });
            
            DOM.playerMsg.innerHTML = "H√£y nh·∫≠p t√™n ƒë·ªÉ th·∫ßn t√†i g√µ c·ª≠a...";
            DOM.playerMsg.className = "h-6 text-center font-bold text-sm text-gray-500 transition-all italic";
            DOM.btnSpin.disabled = true;
            input.focus();
        }

        function resetGame() {
            drawnNumbers = [];
            document.getElementById('history-list').innerHTML = `
                <div id="empty-state" class="h-full flex flex-col items-center justify-center text-gray-400 opacity-70">
                    <i class="fa-solid fa-box-open text-5xl mb-3 text-gray-300"></i>
                    <span class="font-bold">Ch∆∞a c√≥ ai nh·∫≠n qu√†</span>
                </div>`;
            updateCount();
            nextPerson();
        }

        function updateCount() {
            DOM.remainingCount.textContent = allGiftNumbers.length - drawnNumbers.length;
        }
    </script>
</body>
</html>