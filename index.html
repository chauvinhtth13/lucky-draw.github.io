<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YEP 2025 - Gift Exchange Party</title>
    
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;600;700;800&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Nunito"', 'sans-serif'],
                        fun: ['"Baloo 2"', 'cursive'],
                    },
                    colors: {
                        pop: {
                            bg: '#F0F7F4',        
                            card: '#FFFFFF',
                            primary: '#FF6B6B',   
                            secondary: '#4ECDC4', 
                            yellow: '#FFE66D',    
                            dark: '#292F36',      
                            text: '#4A4A4A'
                        }
                    },
                    boxShadow: {
                        'block': '6px 6px 0px 0px rgba(41, 47, 54, 1)', 
                        'block-sm': '3px 3px 0px 0px rgba(41, 47, 54, 1)',
                    },
                    animation: {
                        'pop-in': 'popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        popIn: {
                            '0%': { transform: 'scale(0.8) translateY(20px)', opacity: '0' },
                            '100%': { transform: 'scale(1) translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Nunito', sans-serif;
            overflow: hidden;
            /* Thay m√†u tr·∫Øng b·∫±ng m√†u n·ªÅn c∆° b·∫£n ·∫•m √°p */
            background-color: #ffe6fa; 
        }

        /* =========================================
           NEW BACKGROUND: AURORA PARTY STYLE
           S·ª≠ d·ª•ng GPU (transform) ƒë·ªÉ t·ªëi ∆∞u iPad
        ========================================= */
        .bg-layer {
            position: fixed;
            inset: 0;
            z-index: -10;
            overflow: hidden;
            background: linear-gradient(120deg, #ffe6fa 0%, #e3fdf5 100%); /* N·ªÅn g·ªëc Gradient nh·∫π */
        }

        /* 1. C√°c kh·ªëi m√†u loang (Blobs) */
        .color-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px); /* L√†m m·ªù m·∫°nh ƒë·ªÉ t·∫°o n·ªÅn m·ªãn */
            opacity: 0.8;
            will-change: transform;
            animation: blob-bounce 20s infinite ease-in-out alternate;
        }

        .blob-1 {
            width: 70vh; height: 70vh;
            background: #ff9a9e; /* H·ªìng ƒë√†o */
            top: -10%; left: -10%;
            animation-duration: 25s;
        }
        .blob-2 {
            width: 60vh; height: 60vh;
            background: #a18cd1; /* T√≠m m·ªông m∆° */
            bottom: -10%; right: -10%;
            animation-duration: 30s;
            animation-delay: -5s;
        }
        .blob-3 {
            width: 50vh; height: 50vh;
            background: #4facfe; /* Xanh d∆∞∆°ng */
            top: 40%; left: 30%;
            opacity: 0.6;
            animation-duration: 22s;
            animation-delay: -10s;
        }

        @keyframes blob-bounce {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }

        /* 2. C√°c h√¨nh kh·ªëi bay l∆° l·ª≠ng (Floating Shapes) - T·∫°o s·ª± sinh ƒë·ªông */
        .floating-shapes {
            position: fixed;
            inset: 0;
            z-index: -5;
            pointer-events: none;
        }

        .shape {
            position: absolute;
            opacity: 0.4;
            will-change: transform;
            animation: shape-float linear infinite;
        }

        /* H√¨nh vu√¥ng */
        .shape-sq {
            width: 40px; height: 40px;
            border: 4px solid #FF6B6B;
            border-radius: 8px;
            top: 100%; left: 15%;
            animation-duration: 15s;
            animation-delay: 0s;
        }
        /* H√¨nh tr√≤n */
        .shape-cir {
            width: 30px; height: 30px;
            background: #4ECDC4;
            border-radius: 50%;
            top: 100%; left: 45%;
            animation-duration: 12s;
            animation-delay: 2s;
        }
        /* H√¨nh tam gi√°c (d√πng border css) */
        .shape-tri {
            width: 0; height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-bottom: 35px solid #FFE66D;
            top: 100%; left: 75%;
            animation-duration: 18s;
            animation-delay: 5s;
        }
         /* H√¨nh vu√¥ng ƒë·∫∑c */
         .shape-sq-fill {
            width: 25px; height: 25px;
            background: #a18cd1;
            border-radius: 4px;
            top: 100%; left: 85%;
            animation-duration: 20s;
            animation-delay: 1s;
        }

        @keyframes shape-float {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.5; }
            90% { opacity: 0.5; }
            100% { transform: translateY(-110vh) rotate(360deg); opacity: 0; }
        }

        /* =========================================
           GI·ªÆ NGUY√äN CSS GIAO DI·ªÜN C≈®
        ========================================= */
        .glass-card {
            background: rgba(255, 255, 255, 0.6); /* Gi·∫£m opacity ƒë·ªÉ th·∫•y n·ªÅn ƒë·∫πp h∆°n */
            backdrop-filter: blur(20px); /* TƒÉng blur ƒë·ªÉ t√°ch bi·ªát n·ªôi dung */
            -webkit-backdrop-filter: blur(20px);
            border: 4px solid #292F36;
            border-radius: 30px;
            box-shadow: 12px 12px 0px 0px rgba(41, 47, 54, 0.8);
            position: relative; 
            z-index: 50; 
        }

        .digit-box {
            width: 90px; 
            height: 120px;
            background: #FFE66D;
            border: 4px solid #292F36;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Baloo 2', cursive; 
            font-size: 5rem;
            font-weight: 800;
            color: #292F36;
            box-shadow: 4px 4px 0px 0px #292F36;
            transition: all 0.2s ease;
            line-height: 1;
            padding-top: 10px;
        }
        
        .digit-box.spinning {
            background: #ffffff;
            color: #FF6B6B;
            animation: shake 0.5s ease-in-out infinite;
        }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            75% { transform: rotate(3deg); }
        }

        .btn-blocky {
            border: 3px solid #292F36;
            border-radius: 16px;
            font-weight: 800;
            text-transform: uppercase;
            box-shadow: 5px 5px 0px 0px #292F36;
            transition: all 0.1s ease;
            font-family: 'Baloo 2', cursive;
            letter-spacing: 1px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .btn-blocky::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: 0.5s;
        }
        .btn-blocky:hover::after { left: 100%; }
        
        .btn-blocky:not(:disabled):active {
            transform: translate(4px, 4px);
            box-shadow: 1px 1px 0px 0px #292F36;
        }
        .btn-blocky:disabled {
            background: #e5e7eb !important;
            color: #9ca3af !important;
            border-color: #d1d5db !important;
            box-shadow: 2px 2px 0px 0px #d1d5db !important;
            cursor: not-allowed;
            opacity: 0.8;
        }
        .btn-blocky:not(:disabled):hover { 
            transform: translate(2px, 2px); 
            box-shadow: 3px 3px 0px 0px #292F36; 
        }

        .input-flat {
            border: 3px solid #292F36;
            border-radius: 16px;
            box-shadow: 4px 4px 0px 0px rgba(41, 47, 54, 0.2);
            transition: all 0.2s ease;
            font-family: 'Nunito', sans-serif;
            background: rgba(255,255,255,0.9);
        }
        .input-flat:focus {
            outline: none;
            box-shadow: 6px 6px 0px 0px #4ECDC4;
            border-color: #4ECDC4;
            transform: translateY(-2px);
        }

        .history-item {
            background: rgba(255,255,255,0.9);
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: transform 0.15s ease, border-color 0.15s ease;
            font-family: 'Nunito', sans-serif;
            animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .history-item:hover {
            border-color: #292F36;
            transform: scale(1.02) rotate(-1deg);
            background: #FFF9C4; 
            z-index: 10;
        }

        @keyframes slideIn { 
            from { opacity: 0; transform: translateX(-20px); } 
            to { opacity: 1; transform: translateX(0); } 
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .modal-box {
            border: 4px solid #292F36;
            border-radius: 24px;
            box-shadow: 8px 8px 0px 0px #292F36;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 relative font-sans">

    <div class="bg-layer">
        <div class="color-blob blob-1"></div>
        <div class="color-blob blob-2"></div>
        <div class="color-blob blob-3"></div>
    </div>

    <div class="floating-shapes">
        <div class="shape shape-sq"></div>
        <div class="shape shape-cir"></div>
        <div class="shape shape-tri"></div>
        <div class="shape shape-sq-fill"></div>
        <div class="shape shape-cir" style="left: 20%; animation-delay: 8s; background: #FF9A9E;"></div>
        <div class="shape shape-sq" style="left: 60%; animation-delay: 12s; border-color: #a18cd1;"></div>
    </div>

    <div id="start-overlay" class="fixed inset-0 z-[100] bg-gradient-to-br from-pop-primary/90 via-pop-secondary/90 to-pop-yellow/90 flex items-center justify-center cursor-pointer" onclick="startApp()">
        <div class="text-center animate-pulse">
            <div class="text-8xl mb-6">üéâ</div>
            <h2 class="font-fun text-4xl md:text-5xl text-white font-extrabold drop-shadow-lg mb-4">YEAR END PARTY 2025</h2>
            <p class="text-white/90 text-xl font-bold mb-8">Trao qu√† li·ªÅn tay - V·∫≠n may s·∫Ω t·ªõi</p>
            <div class="inline-flex items-center gap-3 bg-white text-pop-dark px-8 py-4 rounded-2xl font-bold text-xl shadow-block hover:shadow-block-sm hover:translate-x-1 hover:translate-y-1 transition-all">
                <i class="fa-solid fa-play"></i>
                <span>Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu</span>
            </div>
            <p class="text-white/70 text-sm mt-4"><i class="fa-solid fa-volume-high mr-2"></i>√Çm thanh s·∫Ω t·ª± ƒë·ªông ph√°t</p>
        </div>
    </div>

    <div class="w-full max-w-5xl glass-card p-6 md:p-10 flex flex-col gap-8 animate-pop-in">
        
        <div class="flex justify-between items-start">
            <div class="relative">
                <h1 class="font-fun text-5xl md:text-6xl text-pop-dark leading-none font-extrabold drop-shadow-sm">
                    YEAR END PARTY <span class="text-pop-primary inline-block hover:scale-110 transition-transform cursor-pointer">2025</span>
                </h1>
                <p class="text-pop-text font-bold text-lg mt-1 italic opacity-80">Trao qu√† li·ªÅn tay - V·∫≠n may s·∫Ω t·ªõi</p>
            </div>
            
            <div class="flex gap-3">
                <button id="btn-sound" onclick="toggleSound()" class="w-12 h-12 bg-white border-2 border-pop-dark rounded-xl flex items-center justify-center shadow-block-sm hover:shadow-none hover:translate-x-[3px] hover:translate-y-[3px] transition-all group">
                    <i id="icon-sound" class="fa-solid fa-volume-high text-pop-dark text-xl group-hover:scale-110 transition-transform"></i>
                </button>

                <button onclick="my_modal_1.showModal()" class="w-12 h-12 bg-white border-2 border-pop-dark rounded-xl flex items-center justify-center shadow-block-sm hover:shadow-none hover:translate-x-[3px] hover:translate-y-[3px] transition-all group">
                    <i class="fa-solid fa-gear text-pop-dark text-xl group-hover:rotate-90 transition-transform duration-500"></i>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 mt-2">
            
            <div class="lg:col-span-7 flex flex-col items-center gap-8">
                
                <div class="bg-blue-50/80 backdrop-blur w-full p-8 rounded-3xl border-4 border-dashed border-blue-300 flex justify-center items-center gap-4 relative shadow-inner">
                    <div class="absolute -top-4 bg-white px-4 py-1 border-2 border-blue-300 rounded-full text-xs font-extrabold text-blue-500 uppercase tracking-wider shadow-sm">
                        <i class="fa-solid fa-star text-yellow-400 mr-1"></i> Con s·ªë b√≠ ·∫©n
                    </div>
                    <div id="box-1" class="digit-box"><span id="digit-1">?</span></div>
                    <div id="box-2" class="digit-box"><span id="digit-2">?</span></div>
                    <div id="box-3" class="digit-box"><span id="digit-3">?</span></div>
                </div>

                <div class="w-full flex flex-col gap-4">
                    <div class="relative group">
                        <input type="text" id="current-player" oninput="checkPlayer()" onkeypress="handleKeyPress(event)" autocomplete="off"
                            class="input-flat w-full py-4 px-5 pl-14 text-xl font-bold font-sans text-pop-dark placeholder-gray-400" 
                            placeholder="Ai l√† ng∆∞·ªùi may m·∫Øn ti·∫øp theo?">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-pop-secondary transition-colors">
                            <i class="fa-solid fa-user-astronaut text-2xl"></i>
                        </div>
                    </div>

                    <div id="player-msg" class="h-6 text-center font-bold text-sm text-gray-500 transition-all duration-300 italic">
                        H√£y nh·∫≠p t√™n ƒë·ªÉ may m·∫Øn g√µ c·ª≠a...
                    </div>

                    <div class="grid grid-cols-4 gap-4">
                        <button id="btn-spin" onclick="startSpin()" disabled 
                            class="col-span-3 btn-blocky bg-pop-primary text-white text-xl py-4 hover:bg-[#ff5252] flex items-center justify-center gap-3">
                            <i class="fa-solid fa-gift animate-pulse"></i> QUAY S·ªê NGAY
                        </button>
                        <button onclick="nextPerson()" 
                            class="col-span-1 btn-blocky bg-white text-pop-dark border-pop-dark hover:bg-gray-50">
                            <i class="fa-solid fa-forward text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 flex flex-col h-full max-h-[500px]">
                <div class="flex justify-between items-end mb-3 px-1">
                    <h3 class="font-fun text-2xl text-pop-dark font-bold"><i class="fa-solid fa-clock-rotate-left mr-2 text-pop-secondary"></i>L·ªãch s·ª≠</h3>
                    <span class="text-sm font-bold bg-pop-yellow px-3 py-1 rounded-full border-2 border-pop-dark shadow-[2px_2px_0px_0px_rgba(41,47,54,1)]">
                        Kho: <span id="remaining-count">0</span> üéÅ
                    </span>
                </div>

                <div class="bg-white/60 rounded-2xl border-2 border-white p-2 flex-1 overflow-hidden flex flex-col shadow-inner backdrop-blur-sm">
                    <ul id="history-list" class="flex-1 overflow-y-auto space-y-2 p-1 custom-scrollbar">
                        <div id="empty-state" class="h-full flex flex-col items-center justify-center text-gray-400 opacity-70">
                            <i class="fa-solid fa-box-open text-5xl mb-3 text-gray-300"></i>
                            <span class="font-bold">Ch∆∞a c√≥ ai nh·∫≠n qu√†</span>
                            <span class="text-xs">Nhanh tay l√™n n√†o!</span>
                        </div>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <dialog id="my_modal_1" class="modal backdrop-blur-md">
        <div class="modal-box bg-white p-6 max-w-2xl">
            <h3 class="font-fun text-2xl mb-2 text-pop-primary font-bold uppercase border-b-2 border-gray-100 pb-2">
                <i class="fa-solid fa-list-check mr-2"></i>C·∫•u h√¨nh danh s√°ch
            </h3>
            <p class="text-sm text-gray-500 mb-1 mt-2"><b>ƒê·ªãnh d·∫°ng:</b> T√™n Ng∆∞·ªùi Ch∆°i, M√£ qu√† 1, M√£ qu√† 2...</p>
            <textarea id="input-list" class="w-full h-48 bg-gray-50 border-2 border-gray-200 rounded-xl p-4 font-bold text-gray-600 focus:outline-none focus:border-pop-secondary focus:bg-white transition-all duration-300 font-sans resize-none mt-2"
                placeholder="Nguyen Van A, 1, 2, 3&#10;Tran Thi B, 4" spellcheck="false"></textarea>
            <div class="modal-action grid grid-cols-2 gap-4 mt-6">
                <form method="dialog" class="w-full"><button class="btn-blocky w-full py-3 bg-gray-200 text-gray-600 border-gray-400 shadow-[4px_4px_0px_0px_#9ca3af]">ƒê√≥ng</button></form>
                <button onclick="saveData()" class="btn-blocky w-full py-3 bg-pop-secondary text-white border-pop-dark">L∆∞u D·ªØ Li·ªáu</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>

    <script>
        // --- LOGIC GI·ªÆ NGUY√äN ---
        let playerList = [];
        let giftMap = {};
        let allGiftNumbers = [];
        let drawnNumbers = [];
        let isSpinning = false;
        let checkPlayerTimeout;
        let isMuted = false;
        
        const bgMusic = new Audio('sound_nen.mp3'); 
        bgMusic.loop = true; bgMusic.volume = 0.5;

        const spinMusic = new Audio('sound_quay.mp3'); 
        spinMusic.loop = true; spinMusic.volume = 1.0;

        let winAudio = null;
        
        const TOTAL_WIN_SOUNDS = 9;
        let winSoundQueue = [];
        let lastPlayedSounds = [];
        
        function shuffleWinSounds() {
            let sounds = Array.from({length: TOTAL_WIN_SOUNDS}, (_, i) => i + 1);
            for (let i = sounds.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [sounds[i], sounds[j]] = [sounds[j], sounds[i]];
            }
            if (lastPlayedSounds.length > 0) {
                const lastPlayed = lastPlayedSounds[lastPlayedSounds.length - 1];
                if (sounds[0] === lastPlayed) {
                    const swapIdx = Math.floor(Math.random() * (sounds.length - 1)) + 1;
                    [sounds[0], sounds[swapIdx]] = [sounds[swapIdx], sounds[0]];
                }
            }
            return sounds;
        }
        
        function getNextWinSound() {
            if (winSoundQueue.length === 0) {
                winSoundQueue = shuffleWinSounds();
            }
            const soundIndex = winSoundQueue.shift();
            lastPlayedSounds.push(soundIndex);
            if (lastPlayedSounds.length > 3) {
                lastPlayedSounds.shift();
            }
            return soundIndex;
        }

        const defaultData = `Ng·ªçc Dung, 1,
Ph∆∞∆°ng Ly, 2
Qu·ªëc Hi·ªáu, 3, 
Ch√¢u Vinh, 4
T∆∞·ªùng Duy, 5
Thanh T√¢m, 6
Ph∆∞∆°ng Th√πy, 7
Minh Qu√¢n, 8
H·ªìng ƒê√†o, 9
ƒêƒÉng Khoa, 10
Ph∆∞·ª£ng Linh, 11
Sƒ© Nguy√™n, 12, 13, 14, 15
H·ªìng Di·ªÖm, 16
Thi√™n Khang, 17
Th·∫ø H√†o, 18
H·ªìng √Ånh, 19
Thanh Duy, 20
ƒê√¨nh VƒÉn, 21
Minh Th∆∞∆°ng, 22
Vƒ©nh Ph√°t, 23
Nh∆∞ Qu·ª≥nh, 24
Quang Minh, 25
H·ªìng Ch√¢u, 26
Thanh Tuyen, 27`;

        window.onload = function() {
            document.getElementById('input-list').value = defaultData;
            saveData(false);
        }

        function startApp() {
            const overlay = document.getElementById('start-overlay');
            overlay.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            overlay.style.opacity = '0';
            overlay.style.transform = 'scale(1.1)';
            setTimeout(() => { overlay.style.display = 'none'; }, 500);
            if (!isMuted) bgMusic.play().catch(e => console.log("L·ªói ph√°t nh·∫°c:", e));
            DOM.currentPlayer.focus();
        }

        function updateSoundButtonUI() {
            const icon = document.getElementById('icon-sound');
            const btn = document.getElementById('btn-sound');
            
            if (isMuted) {
                icon.className = 'fa-solid fa-volume-xmark text-gray-500 text-xl group-hover:scale-110 transition-transform';
                btn.className = 'w-12 h-12 bg-gray-100 border-2 border-gray-400 rounded-xl flex items-center justify-center shadow-none transition-all group';
            } else {
                icon.className = 'fa-solid fa-volume-high text-pop-dark text-xl group-hover:scale-110 transition-transform';
                btn.className = 'w-12 h-12 bg-white border-2 border-pop-dark rounded-xl flex items-center justify-center shadow-block-sm hover:shadow-none hover:translate-x-[3px] hover:translate-y-[3px] transition-all group';
            }
        }

        function toggleSound() {
            isMuted = !isMuted;
            if (isMuted) {
                bgMusic.pause(); spinMusic.pause(); if(winAudio) winAudio.pause();
            } else {
                if (!isSpinning) bgMusic.play().catch(e => console.log("C·∫ßn t∆∞∆°ng t√°c ƒë·ªÉ ph√°t nh·∫°c"));
                else spinMusic.play().catch(e => console.log(e));
            }
            updateSoundButtonUI();
        }

        function normalizeStr(str) {
            if (!str) return "";
            return str.normalize('NFC').trim().replace(/\s+/g, ' ').toLowerCase();
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !document.getElementById('btn-spin').disabled) startSpin();
        }

        function saveData(showAlert = true) {
            const raw = document.getElementById('input-list').value.trim();
            if (!raw) { alert('Vui l√≤ng nh·∫≠p danh s√°ch!'); return; }
            
            const lines = raw.split('\n').filter(line => line.trim());
            playerList = []; giftMap = {}; allGiftNumbers = []; drawnNumbers = [];
            const usedNumbers = new Set();
            
            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 2) {
                    const nameRaw = parts[0];
                    const giftNumbers = [];
                    for (let i = 1; i < parts.length; i++) {
                        const num = parseInt(parts[i]);
                        if (!isNaN(num) && num > 0) {
                            if (!usedNumbers.has(num)) {
                                usedNumbers.add(num);
                                giftNumbers.push(num);
                                allGiftNumbers.push(num);
                                giftMap[num] = nameRaw.trim();
                            }
                        }
                    }
                    if (nameRaw && giftNumbers.length > 0) {
                        playerList.push({
                            name: nameRaw.trim(),
                            searchKey: normalizeStr(nameRaw),
                            giftNumbers: giftNumbers
                        });
                    }
                }
            });
            
            if (playerList.length === 0) { alert('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá!'); return; }
            resetGame();
            document.getElementById('my_modal_1').close();
            if (showAlert) alert(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t: ${playerList.length} ng∆∞·ªùi v·ªõi ${allGiftNumbers.length} m√≥n qu√†.`);
        }

        const DOM = {
            get currentPlayer() { return document.getElementById('current-player'); },
            get playerMsg() { return document.getElementById('player-msg'); },
            get btnSpin() { return document.getElementById('btn-spin'); },
            get historyList() { return document.getElementById('history-list'); },
            get remainingCount() { return document.getElementById('remaining-count'); },
            get emptyState() { return document.getElementById('empty-state'); },
        };

        function checkPlayer() {
            clearTimeout(checkPlayerTimeout);
            checkPlayerTimeout = setTimeout(() => {
                const inputVal = DOM.currentPlayer.value;
                const searchKey = normalizeStr(inputVal);
                const msg = DOM.playerMsg;
                const btn = DOM.btnSpin;

                if (searchKey === "") {
                    msg.innerHTML = "H√£y nh·∫≠p t√™n ƒë·ªÉ th·∫ßn t√†i g√µ c·ª≠a...";
                    msg.className = "h-6 text-center font-bold text-sm text-gray-500 transition-all italic";
                    btn.disabled = true;
                    return;
                }
                
                const player = playerList.find(p => p.searchKey === searchKey);
                if (player) {
                    msg.innerHTML = `<i class="fa-solid fa-check-circle"></i> Ch√†o <b>${player.name}</b>! Ch√∫c b·∫°n may m·∫Øn!`;
                    msg.className = "h-6 text-center font-bold text-sm text-pop-secondary transition-all";
                    btn.disabled = false;
                } else {
                    msg.innerHTML = `<i class="fa-solid fa-circle-xmark"></i> Kh√¥ng t√¨m th·∫•y t√™n trong danh s√°ch...`;
                    msg.className = "h-6 text-center font-bold text-sm text-red-400 transition-all";
                    btn.disabled = true;
                }
            }, 100); 
        }

        function startSpin() {
            if (isSpinning) return;
            bgMusic.pause();
            if(!isMuted) { spinMusic.currentTime = 0; spinMusic.play(); }

            const inputVal = DOM.currentPlayer.value;
            const currentPlayer = playerList.find(p => p.searchKey === normalizeStr(inputVal));
            const drawnSet = new Set(drawnNumbers);
            const excludeNumbers = currentPlayer ? new Set(currentPlayer.giftNumbers) : new Set();
            let availableNumbers = allGiftNumbers.filter(num => !drawnSet.has(num) && !excludeNumbers.has(num));

            if (availableNumbers.length === 0) {
                const remaining = allGiftNumbers.filter(num => !drawnSet.has(num));
                if (remaining.length > 0) {
                    alert("Ch·ªâ c√≤n l·∫°i qu√† 1 ph·∫ßn qu√†! H√£y ho√°n ƒë·ªïi v·ªõi ng∆∞·ªùi kh√°c.");
                    availableNumbers = remaining;
                } else {
                    alert("ƒê√£ h·∫øt qu√† r·ªìi!");
                    spinMusic.pause();
                    if(!isMuted) bgMusic.play();
                    return;
                }
            }

            const winnerNum = availableNumbers[Math.floor(Math.random() * availableNumbers.length)];
            const winnerStr = winnerNum.toString().padStart(3, '0');

            isSpinning = true;
            DOM.btnSpin.disabled = true;
            DOM.currentPlayer.disabled = true;

            const boxes = [document.getElementById('box-1'), document.getElementById('box-2'), document.getElementById('box-3')];
            const digits = [document.getElementById('digit-1'), document.getElementById('digit-2'), document.getElementById('digit-3')];

            boxes.forEach(box => box.classList.add('spinning'));
            
            const revealDigit = (box, digit, value) => {
                if (digit._animFrame) { cancelAnimationFrame(digit._animFrame); digit._animFrame = null; }
                digit.textContent = value;
                box.classList.remove('spinning');
                box.style.background = '#FF6B6B';
                box.style.color = 'white';
                box.style.borderColor = '#FF6B6B';
                box.style.transform = 'scale(1.1)';
                setTimeout(() => box.style.transform = 'scale(1)', 200);
            };

            digits.forEach(digit => {
                let lastUpdate = 0;
                const animate = (timestamp) => {
                    if (timestamp - lastUpdate >= 50) { 
                        digit.textContent = Math.floor(Math.random() * 10);
                        lastUpdate = timestamp;
                    }
                    digit._animFrame = requestAnimationFrame(animate);
                };
                digit._animFrame = requestAnimationFrame(animate);
            });

            [1500, 2500, 3500].forEach((time, i) => {
                setTimeout(() => {
                    revealDigit(boxes[i], digits[i], winnerStr[i]);
                    if (i === 2) setTimeout(() => finalizeSpin(winnerNum, currentPlayer?.name || "Kh√°ch M·ªùi"), 300);
                }, time);
            });
        }

        function finalizeSpin(number, playerName) {
            isSpinning = false;
            drawnNumbers.push(number);
            spinMusic.pause();
            if (!isMuted) {
                const soundIndex = getNextWinSound();
                winAudio = new Audio(`sound_trung (${soundIndex}).mp3`);
                winAudio.play().catch(e => console.log("L·ªói ph√°t √¢m thanh:", e));
            }
            setTimeout(() => {
                if(winAudio) winAudio.pause();
                if(!isMuted) bgMusic.play();
            }, 6000);

            runFireworks(); 
            const giftOwner = giftMap[number] || "???";
            updateHistory(number, playerName, giftOwner);
            updateCount();
        }

        function runFireworks() {
            const duration = 3000;
            const animationEnd = Date.now() + duration;
            const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#FFFFFF', '#DDA0DD'];
            const interval = setInterval(() => {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) { clearInterval(interval); return; }
                const particleCount = Math.floor(40 * (timeLeft / duration));
                confetti({
                    particleCount: particleCount,
                    startVelocity: 30,
                    spread: 360,
                    origin: { x: Math.random(), y: Math.random() - 0.2 },
                    colors,
                    zIndex: 9999,
                    shapes: ['square', 'circle']
                });
            }, 250);
        }

        function updateHistory(number, playerName, giftOwner) {
            const ul = DOM.historyList;
            if (DOM.emptyState) DOM.emptyState.style.display = 'none';

            const li = document.createElement('li');
            li.className = 'history-item flex justify-between items-center px-4 py-3';
            const numStr = number.toString().padStart(3, '0');
            li.innerHTML = `
                <div class="flex flex-col">
                    <span class="font-bold text-pop-dark truncate text-lg">${playerName}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-fun text-2xl text-pop-primary font-bold bg-red-50 px-3 py-1 rounded-xl border border-red-100 shadow-sm">${numStr}</span>
                </div>
            `;
            ul.prepend(li);
        }

        function nextPerson() {
            if (isSpinning) return;
            const input = DOM.currentPlayer;
            input.value = ""; input.disabled = false;
            ['box-1', 'box-2', 'box-3'].forEach((boxId, i) => {
                const box = document.getElementById(boxId);
                const digit = document.getElementById(`digit-${i + 1}`);
                if (digit._animFrame) { cancelAnimationFrame(digit._animFrame); digit._animFrame = null; }
                digit.textContent = "?";
                box.style.background = ''; box.style.color = ''; box.style.borderColor = ''; box.style.transform = '';
                box.classList.remove('spinning');
            });
            DOM.playerMsg.innerHTML = "H√£y nh·∫≠p t√™n ƒë·ªÉ may m·∫Øn g√µ c·ª≠a...";
            DOM.playerMsg.className = "h-6 text-center font-bold text-sm text-gray-500 transition-all italic";
            DOM.btnSpin.disabled = true;
            input.focus();
        }

        function resetGame() {
            drawnNumbers = [];
            document.getElementById('history-list').innerHTML = `
                <div id="empty-state" class="h-full flex flex-col items-center justify-center text-gray-400 opacity-70">
                    <i class="fa-solid fa-box-open text-5xl mb-3 text-gray-300"></i>
                    <span class="font-bold">Ch∆∞a c√≥ ai nh·∫≠n qu√†</span>
                </div>`;
            updateCount();
            nextPerson();
        }

        function updateCount() {
            DOM.remainingCount.textContent = allGiftNumbers.length - drawnNumbers.length;
        }
    </script>
</body>
</html>